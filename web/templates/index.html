<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandoc Online Converter</title>

    <!-- Fonts: Roboto and Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

    <!-- Material Web Import Map -->
    <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>
    
    <!-- Component Imports -->
    <script type="module">
      import '@material/web/all.js';
      import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';
      document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>

    <style>
        :root {
            /* Material 3 Token Simulation (Light Theme - Default) */
            --md-sys-color-primary: #00044b;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #dfe0ff;
            --md-sys-color-on-primary-container: #000030;
            --md-sys-color-secondary: #575e71;
            --md-sys-color-secondary-container: #dbe2f9;
            --md-sys-color-tertiary: #715573;
            --md-sys-color-tertiary-container: #fbd7fc;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-background: #fdfbff;
            --md-sys-color-on-background: #1a1b1e;
            --md-sys-color-surface: #fdfbff;
            --md-sys-color-on-surface: #1a1b1e;
            --md-sys-color-surface-variant: #e1e2ec;
            --md-sys-color-on-surface-variant: #44474f;
            --md-sys-color-outline: #74777f;
            --md-sys-color-inverse-on-surface: #f2f0f4;
            --md-sys-color-inverse-surface: #2f3033;
            
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Theme Tokens */
        body.dark-theme {
            --md-sys-color-primary: #bcc2ff;
            --md-sys-color-on-primary: #001a41;
            --md-sys-color-primary-container: #002e69;
            --md-sys-color-on-primary-container: #dfe0ff;
            --md-sys-color-secondary: #bfc6dc;
            --md-sys-color-secondary-container: #3f4759;
            --md-sys-color-tertiary: #dfbbde;
            --md-sys-color-tertiary-container: #583e5a;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-error-container: #93000a;
            --md-sys-color-background: #1a1b1e;
            --md-sys-color-on-background: #e3e2e6;
            --md-sys-color-surface: #1a1b1e;
            --md-sys-color-on-surface: #e3e2e6;
            --md-sys-color-surface-variant: #44474f;
            --md-sys-color-on-surface-variant: #c4c6d0;
            --md-sys-color-outline: #8e9099;
            --md-sys-color-inverse-on-surface: #1a1b1e;
            --md-sys-color-inverse-surface: #e3e2e6;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top App Bar */
        header {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            padding: 0 16px;
            height: 64px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            font-size: 22px;
            font-weight: 400; /* Regular for Material */
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }

        /* Layout */
        main {
            flex: 1;
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @media (min-width: 768px) {
            .grid-layout {
                grid-template-columns: 350px 1fr;
            }
        }

        /* Cards/Surfaces */
        .surface-card {
            background-color: var(--md-sys-color-surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            /* Simulating md-elevation-1 */
            border: 1px solid var(--md-sys-color-surface-variant);
        }

        h2 {
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 1.375rem;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        /* Drag and Drop Zone */
        .drop-zone {
            border: 2px dashed var(--md-sys-color-outline);
            border-radius: 8px;
            padding: 32px 16px;
            text-align: center;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .drop-zone:hover, .drop-zone--dragover {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        .drop-zone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        md-filled-select, md-filled-button, md-outlined-button {
            width: 100%;
            margin-bottom: 8px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        tr:last-child td {
            border-bottom: none;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-success { background: #e6f4ea; color: #137333; }
        .status-pending { background: #fef7e0; color: #b06000; }
        .status-error { background: #fce8e6; color: #c5221f; }

        /* Alerts */
        .alert-area {
            margin-bottom: 16px;
        }
        
        .alert-card {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-error {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        
        .alert-success {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <a href="/" class="logo">
            <md-icon>description</md-icon>
            Pandoc Web Service
        </a>
        <div style="flex: 1;"></div>
        
        <span style="position: relative;">
            <md-icon-button id="theme-toggle">
                <md-icon>brightness_auto</md-icon>
            </md-icon-button>
            
            <md-menu id="theme-menu" anchor="theme-toggle">
                <md-menu-item data-theme="system">
                    <div slot="headline">Sync with System</div>
                    <md-icon slot="start">brightness_auto</md-icon>
                </md-menu-item>
                <md-menu-item data-theme="light">
                    <div slot="headline">Light Mode</div>
                    <md-icon slot="start">light_mode</md-icon>
                </md-menu-item>
                <md-menu-item data-theme="dark">
                    <div slot="headline">Dark Mode</div>
                    <md-icon slot="start">dark_mode</md-icon>
                </md-menu-item>
            </md-menu>
        </span>
    </header>

    <main>
        <div class="grid-layout">
            <!-- Left Column: Upload -->
            <section>
                <div class="surface-card">
                    <h2>New Conversion</h2>
                    
                    <div id="alert-area" class="alert-area"></div>

                    <form id="convert-form">
                        <!-- Drop Zone -->
                        <div class="drop-zone" id="drop-zone">
                            <div class="drop-zone-content">
                                <md-icon style="font-size: 40px;">cloud_upload</md-icon>
                                <span id="drop-zone-prompt">Drag file here or click</span>
                            </div>
                            <input type="file" id="file" name="file" required>
                        </div>

                        <!-- Format Selection -->
                        <div class="form-group">
                            <md-filled-select label="From Format" id="from_format" name="from_format" required>
                                <md-select-option value="" disabled selected>
                                    <div slot="headline">Select format</div>
                                </md-select-option>
                                {% for fmt in formats %}
                                <md-select-option value="{{ fmt.key }}">
                                    <div slot="headline">{{ fmt.name }}</div>
                                </md-select-option>
                                {% endfor %}
                            </md-filled-select>
                        </div>

                        <div class="form-group">
                            <md-filled-select label="To Format" id="to_format" name="to_format" disabled required>
                                <md-select-option value="" disabled selected>
                                    <div slot="headline">Select source first</div>
                                </md-select-option>
                            </md-filled-select>
                        </div>

                        <!-- Progress Bar (Hidden by default) -->
                        <md-linear-progress id="progress-bar" indeterminate class="hidden" style="width: 100%; margin-bottom: 16px;"></md-linear-progress>

                        <!-- Actions -->
                        <md-filled-button type="submit" id="convert-btn">
                            Convert Now
                            <md-icon slot="icon">transform</md-icon>
                        </md-filled-button>
                    </form>
                    
                    <div id="format-warning" class="alert-card alert-error hidden" style="margin-top: 16px;">
                        <md-icon>warning</md-icon>
                        <span id="format-warning-text"></span>
                    </div>
                </div>
            </section>

            <!-- Right Column: Jobs -->
            <section>
                <div class="surface-card" style="min-height: 500px;">
                    <h2>My Conversions</h2>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Conversion</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-jobs-msg" style="text-align: center; padding: 24px; color: var(--md-sys-color-secondary);" class="hidden">
                        <md-icon style="font-size: 48px; opacity: 0.5; margin-bottom: 8px;">inbox</md-icon>
                        <div>No conversions found</div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const formats = {{ formats|tojson }};
        const fromSelect = document.getElementById('from_format');
        const toSelect = document.getElementById('to_format');
        const convertBtn = document.getElementById('convert-btn');
        const progressBar = document.getElementById('progress-bar');
        const formatWarning = document.getElementById('format-warning');
        const formatWarningText = document.getElementById('format-warning-text');
        const convertForm = document.getElementById('convert-form');
        const alertArea = document.getElementById('alert-area');
        const jobsTableBody = document.getElementById('jobs-table-body');
        const noJobsMsg = document.getElementById('no-jobs-msg');
        
        // --- Drag & Drop / Auto-Detection ---
        const dropZone = document.getElementById('drop-zone');
        const dropZonePrompt = document.getElementById('drop-zone-prompt');
        const fileInput = document.getElementById('file');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-zone--dragover');
        });

        ['dragleave', 'dragend'].forEach(type => {
            dropZone.addEventListener(type, () => {
                dropZone.classList.remove('drop-zone--dragover');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone--dragover');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(fileInput.files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFileSelect(fileInput.files[0]);
            }
        });

        function handleFileSelect(file) {
            dropZonePrompt.textContent = `Selected: ${file.name}`;
            
            const filename = file.name.toLowerCase();
            const extension = '.' + filename.split('.').pop();
            
            let matchedFormat = null;
            if (extension === '.pdf') {
                matchedFormat = formats.find(f => f.key === 'pdf_marker');
            } else {
                matchedFormat = formats.find(f => f.extension === extension && f.direction !== 'Output Only');
                if (!matchedFormat && (extension === '.md' || extension === '.markdown')) {
                    matchedFormat = formats.find(f => f.key === 'markdown');
                }
            }

            if (matchedFormat) {
                // Accessing value for md-filled-select might need .selectIndex or matching value
                // For material web components, setting value directly often works if options exist
                fromSelect.value = matchedFormat.key;
                
                // Dispatch change event manually since setting value doesn't always trigger it
                updateTargetOptions(matchedFormat.key);
            }
        }

        // --- Format Selection Logic ---
        // md-select dispatches 'input' or 'change' (check docs, usually 'input' works)
        fromSelect.addEventListener('input', function() {
            updateTargetOptions(this.value);
        });

        function updateTargetOptions(selectedKey) {
            const selectedFormat = formats.find(f => f.key === selectedKey);
            
            // Reset UI
            formatWarning.classList.add('hidden');
            convertBtn.disabled = false;
            toSelect.disabled = false;
            
            // Clear existing options (except placeholder if we want one, but md-select handles this differently)
            // We need to rebuild the md-select-option children
            while (toSelect.firstChild) {
                toSelect.removeChild(toSelect.firstChild);
            }

            // Add placeholder
            const placeholder = document.createElement('md-select-option');
            placeholder.value = "";
            placeholder.disabled = true;
            placeholder.selected = true;
            placeholder.innerHTML = '<div slot="headline">Select target format</div>';
            toSelect.appendChild(placeholder);

            if (!selectedFormat) return;

            if (selectedFormat.direction === 'Output Only') {
                formatWarningText.innerText = `${selectedFormat.name} is only available as an output format.`;
                formatWarning.classList.remove('hidden');
                convertBtn.disabled = true;
                toSelect.disabled = true;
                return;
            }

            formats.forEach(f => {
                if (f.key !== selectedKey && f.direction !== 'Input Only') {
                    const opt = document.createElement('md-select-option');
                    opt.value = f.key;
                    opt.innerHTML = `<div slot="headline">${f.name}</div>`;
                    toSelect.appendChild(opt);
                }
            });
        }

        // --- Form Submission ---
        convertForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const file = fileInput.files[0];
            const fromVal = fromSelect.value;
            const toVal = toSelect.value;
            
            if(!file || !fromVal || !toVal) {
                showAlert('error', 'Please fill all fields');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('from_format', fromVal);
            formData.append('to_format', toVal);

            convertBtn.disabled = true;
            progressBar.classList.remove('hidden');

            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    showAlert('success', 'Conversion started successfully!');
                    // Reset form
                    fileInput.value = '';
                    dropZonePrompt.textContent = "Drag file here or click";
                    fromSelect.value = '';
                    toSelect.value = '';
                    toSelect.disabled = true;
                    
                    startPolling(true);
                } else {
                    showAlert('error', data.error || 'An error occurred.');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('error', 'Failed to submit conversion request.');
            } finally {
                convertBtn.disabled = false;
                progressBar.classList.add('hidden');
            }
        });

        function showAlert(type, message) {
            if (alertTimeout) clearTimeout(alertTimeout);
            
            alertArea.innerHTML = '';
            const card = document.createElement('div');
            card.className = `alert-card ${type === 'error' ? 'alert-error' : 'alert-success'}`;
            card.innerHTML = `
                <md-icon>${type === 'error' ? 'error' : 'check_circle'}</md-icon>
                <span>${message}</span>
            `;
            alertArea.appendChild(card);

            alertTimeout = setTimeout(() => {
                alertArea.innerHTML = '';
                alertTimeout = null;
            }, 5000);
        }

        // --- Polling (Simplified for brevity, logic remains similar) ---
        const POLL_INTERVAL_ACTIVE = 5000;
        const POLL_INTERVAL_IDLE = 15000;
        let pollInterval = null;
        let fetchController = null;
        let alertTimeout = null;

        function startPolling(hasActiveJobs = false) {
            stopPolling();
            const interval = hasActiveJobs ? POLL_INTERVAL_ACTIVE : POLL_INTERVAL_IDLE;
            fetchJobs();
            pollInterval = setInterval(fetchJobs, interval);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) stopPolling();
            else fetchJobs(); // Resume check
        });

        async function fetchJobs() {
            if (fetchController) fetchController.abort();
            fetchController = new AbortController();

            try {
                const response = await fetch('/api/jobs', { signal: fetchController.signal });
                const jobs = await response.json();
                renderJobs(jobs);
                
                const hasActive = jobs.some(j => ['PENDING', 'PROCESSING', 'STARTED'].includes(j.status));
                
                // Adjust poll rate if state changed
                if (hasActive && (!pollInterval || pollInterval._idleTimeout !== POLL_INTERVAL_ACTIVE)) {
                    startPolling(true);
                } else if (!hasActive && pollInterval && pollInterval._idleTimeout !== POLL_INTERVAL_IDLE) {
                    startPolling(false);
                }
                
            } catch (error) {
                if (error.name !== 'AbortError') console.error('Error fetching jobs:', error);
            }
        }

        // --- Event Delegation for Job Actions ---
        jobsTableBody.addEventListener('click', async (e) => {
            // Traverse up to find button or anchor
            const btn = e.target.closest('md-filled-button, md-outlined-button'); 
            if (!btn) return;
            
            const action = btn.dataset.action;
            const jobId = btn.dataset.jobId;
            
            // Note: md-button is a web component, clicks inside usually bubble
            if (action === 'cancel') {
                if (!confirm('Cancel this job?')) return;
                try {
                    await fetch(`/api/cancel/${jobId}`, { method: 'POST' });
                    fetchJobs();
                } catch(e) { console.error(e); }
            } else if (action === 'retry') {
                try {
                    await fetch(`/api/retry/${jobId}`, { method: 'POST' });
                    startPolling(true);
                } catch(e) { console.error(e); }
            }
        });

        function renderJobs(jobs) {
            if (jobs.length === 0) {
                jobsTableBody.innerHTML = '';
                noJobsMsg.classList.remove('hidden');
                return;
            }
            noJobsMsg.classList.add('hidden');

            const rows = jobs.map(job => {
                let statusBadge = '';
                let actionBtn = '';

                switch(job.status) {
                    case 'PENDING':
                    case 'STARTED':
                    case 'PROCESSING':
                        statusBadge = `<span class="status-badge status-pending">In Progress</span>`;
                        actionBtn = `<md-outlined-button data-action="cancel" data-job-id="${job.id}">Cancel</md-outlined-button>`;
                        break;
                    case 'SUCCESS':
                        statusBadge = `<span class="status-badge status-success">Completed</span>`;
                        // Standard anchor wrapper for robust download behavior
                        actionBtn = `<a href="/download/${job.id}" download style="text-decoration: none; display: inline-block;">
                                        <md-filled-button>
                                            Download
                                            <md-icon slot="icon">download</md-icon>
                                        </md-filled-button>
                                     </a>`;
                        break;
                    case 'FAILURE':
                        statusBadge = `<span class="status-badge status-error">Failed</span>`;
                        actionBtn = `<md-outlined-button data-action="retry" data-job-id="${job.id}">Retry</md-outlined-button>`;
                        break;
                    case 'REVOKED':
                        statusBadge = `<span class="status-badge">Cancelled</span>`;
                        actionBtn = `<md-outlined-button data-action="retry" data-job-id="${job.id}">Retry</md-outlined-button>`;
                        break;
                    default:
                        statusBadge = job.status;
                }

                const errorMsg = job.result ? `<div style="font-size:12px; color:var(--md-sys-color-error); margin-top:4px;">${job.result.substring(0,60)}...</div>` : '';

                return `
                    <tr>
                        <td>
                            <div style="font-weight:500;">${job.filename}</div>
                            <div style="font-size:12px; color:var(--md-sys-color-secondary);">${new Date(job.created_at).toLocaleTimeString()}</div>
                        </td>
                        <td>${job.from} &rarr; ${job.to}</td>
                        <td>
                            ${statusBadge}
                            ${errorMsg}
                        </td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });

            jobsTableBody.innerHTML = rows.join('');
        }
        
        startPolling(false);

        // --- Theme Customization ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeMenu = document.getElementById('theme-menu');
        const themeMenuItems = themeMenu.querySelectorAll('md-menu-item');
        
        themeToggle.addEventListener('click', () => {
            themeMenu.open = !themeMenu.open;
        });

        themeMenuItems.forEach(item => {
            item.addEventListener('close-menu', () => {
                const theme = item.getAttribute('data-theme');
                setTheme(theme);
            });
        });

        function getSavedTheme() {
            return localStorage.getItem('theme') || 'system';
        }

        function setTheme(theme) {
            if (theme === 'system') {
                localStorage.removeItem('theme');
            } else {
                localStorage.setItem('theme', theme);
            }
            applyTheme(theme);
        }

        function applyTheme(theme) {
            let effectiveTheme = theme;
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (theme === 'system') {
                effectiveTheme = systemDark ? 'dark' : 'light';
            }

            if (effectiveTheme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }

            // Update Icon
            const icon = themeToggle.querySelector('md-icon');
            if (theme === 'system') icon.textContent = 'brightness_auto';
            else if (theme === 'light') icon.textContent = 'light_mode';
            else if (theme === 'dark') icon.textContent = 'dark_mode';
        }

        // System preference listener
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (getSavedTheme() === 'system') {
                applyTheme('system');
            }
        });

        // Initialize
        applyTheme(getSavedTheme());

    </script>
</body>
</html>