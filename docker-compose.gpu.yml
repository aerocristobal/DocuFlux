# GPU Profile Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.gpu.yml up
# Or: docker-compose --profile gpu up (if profiles added to main compose file)

services:
  worker:
    image: worker:gpu
    build:
      context: ./worker
      dockerfile: Dockerfile
      args:
        BUILD_GPU: "true"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_METADATA_URL=redis://redis:6379/1
      - MARKER_ENABLED=true
      - BUILD_GPU=true
    command: celery -A tasks worker --loglevel=info --pool=solo --without-mingle --without-gossip -Q high_priority,default
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 18G  # 16GB VRAM + 2GB system (Epic 21.4)
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - gpu

  beat:
    profiles:
      - gpu
